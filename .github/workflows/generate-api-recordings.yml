name: Generate API Recordings

on:
  workflow_dispatch:
    inputs:
      record_limit:
        description: 'Number of scripts to record (0 = all)'
        required: false
        type: number
        default: 0
  push:
    branches:
      - main
    paths:
      - 'tools/recording-utilities/recording_automations_api/**'

permissions:
  contents: write

env:
  RECORDINGS_DIR: tools/recording-utilities/recording_automations_api/recordings/api
  AGG_IMAGE: ghcr.io/asciinema/agg:latest

jobs:
  record:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────────────────────
      # Setup
      # ─────────────────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Install Phantom-WG
        run: |
          chmod +x phantom-install.sh
          sudo ./phantom-install.sh

      - name: Verify Phantom-WG Installation
        run: |
          if [ ! -d "/opt/phantom-wg" ] || [ ! -f "/opt/phantom-wg/.phantom-venv/bin/python" ]; then
            echo "Error: Phantom-WG installation failed"
            exit 1
          fi
          echo "Phantom-WG installation verified"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y asciinema jq

      # ─────────────────────────────────────────────────────────────
      # Pull agg Docker Image
      # ─────────────────────────────────────────────────────────────
      - name: Pull agg Docker Image
        run: docker pull ${{ env.AGG_IMAGE }}

      # ─────────────────────────────────────────────────────────────
      # Generate Recordings
      # ─────────────────────────────────────────────────────────────
      - name: Generate API Recordings
        working-directory: tools/recording-utilities/recording_automations_api
        env:
          TERM: xterm-256color
          UNVEIL_DELAY: "0.04"
          RECORD_LIMIT: ${{ inputs.record_limit || 0 }}
        run: |
          chmod +x automate.sh
          chmod +x api/*.sh

          echo "RECORD_LIMIT=$RECORD_LIMIT"
          sudo -E ./automate.sh

      # ─────────────────────────────────────────────────────────────
      # Convert .cast to .gif
      # ─────────────────────────────────────────────────────────────
      - name: Convert Recordings to GIF
        run: |
          echo "Converting .cast files to .gif..."

          for cast_file in ${{ env.RECORDINGS_DIR }}/*.cast; do
            [ -f "$cast_file" ] || continue

            filename=$(basename "$cast_file" .cast)
            gif_file="${{ env.RECORDINGS_DIR }}/${filename}.gif"

            echo "  Converting: $filename.cast → $filename.gif"

            docker run --rm \
              -v "$(pwd)/${{ env.RECORDINGS_DIR }}:/data" \
              ${{ env.AGG_IMAGE }} \
              "/data/${filename}.cast" \
              "/data/${filename}.gif" \
              --font-size 14 \
              --cols 120 \
              --rows 48
          done

          echo ""
          echo "Conversion complete. Files:"
          ls -la ${{ env.RECORDINGS_DIR }}/

      # ─────────────────────────────────────────────────────────────
      # Upload Artifacts
      # ─────────────────────────────────────────────────────────────
      - name: Upload Recordings Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: api-recordings-${{ github.run_id }}
          path: |
            ${{ env.RECORDINGS_DIR }}/*.cast
            ${{ env.RECORDINGS_DIR }}/*.gif
          retention-days: 90

      # ─────────────────────────────────────────────────────────────
      # Commit Recordings
      # ─────────────────────────────────────────────────────────────
      - name: Prepare Recordings for Commit
        run: |
          TARGET_DIR="documentation/docs/assets/static/recordings/feature-showcase/api"
          mkdir -p "$TARGET_DIR"

          for cast_file in ${{ env.RECORDINGS_DIR }}/*.cast; do
            [ -f "$cast_file" ] || continue
            filename=$(basename "$cast_file" .cast)
            cp "$cast_file" "$TARGET_DIR/$filename"
            echo "Copied: $filename"
          done

          echo ""
          echo "Files ready for commit:"
          ls -la "$TARGET_DIR/"

      - name: Commit and Push Recordings
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git config user.name "phantom-ci"
          git config user.email "no-reply@ci.phantom-wg.dev"

          git add documentation/docs/assets/static/recordings/feature-showcase/api/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update API recordings"
            git push
            echo "Recordings committed and pushed"
          fi


name: Generate API Recordings

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  record:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Phantom-WG
        run: |
          chmod +x phantom-install.sh
          sudo ./phantom-install.sh

      - name: Verify Phantom-WG Installation
        run: |
          echo "Verifying Phantom-WG installation..."
          if [ ! -d "/opt/phantom-wg" ]; then
            echo "Error: Installation directory not found"
            exit 1
          fi
          if [ ! -f "/opt/phantom-wg/.phantom-venv/bin/python" ]; then
            echo "Error: Virtual environment not found"
            exit 1
          fi
          echo "Installation verified successfully"

      - name: Install Recording Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y asciinema jq

      - name: Setup Live Terminal Stream
        run: |
          # ttyd - web terminal
          sudo wget -q https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.x86_64 -O /usr/local/bin/ttyd
          sudo chmod +x /usr/local/bin/ttyd

          # cloudflared tunnel
          sudo wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared

      - name: Start Live Stream
        run: |
          # Start ttyd on port 7681
          ttyd -W -p 7681 bash &
          sleep 2

          # Start cloudflare tunnel
          cloudflared tunnel --url http://localhost:7681 > tunnel.log 2>&1 &
          sleep 5

          # Extract and display the public URL
          echo "════════════════════════════════════════════════════════════"
          echo "  LIVE TERMINAL STREAM"
          echo "════════════════════════════════════════════════════════════"
          TUNNEL_URL=$(grep -o 'https://[^[:space:]]*\.trycloudflare\.com' tunnel.log | head -1)
          echo "  URL: $TUNNEL_URL"
          echo "════════════════════════════════════════════════════════════"
          echo ""

          # Save URL for later steps
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV

      - name: Generate API Recordings
        working-directory: documentation/tools/scripts/recording_automations_api
        env:
          TERM: xterm-256color
        run: |
          chmod +x automate.sh
          chmod +x api/*.sh
          sudo -E ./automate.sh

      - name: Upload Recordings Artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-recordings-${{ github.run_id }}
          path: documentation/tools/scripts/recording_automations_api/recordings/api/
          retention-days: 90

name: Generate API Recordings

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (only record first 3 scripts)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

env:
  RECORDINGS_DIR: documentation/tools/scripts/recording_automations_api/recordings/api
  AGG_IMAGE: ghcr.io/asciinema/agg:latest

jobs:
  record:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────────────────────
      # Setup
      # ─────────────────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Phantom-WG
        run: |
          chmod +x phantom-install.sh
          sudo ./phantom-install.sh

      - name: Verify Phantom-WG Installation
        run: |
          if [ ! -d "/opt/phantom-wg" ] || [ ! -f "/opt/phantom-wg/.phantom-venv/bin/python" ]; then
            echo "Error: Phantom-WG installation failed"
            exit 1
          fi
          echo "Phantom-WG installation verified"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y asciinema jq

      # ─────────────────────────────────────────────────────────────
      # Live Stream Tools
      # ─────────────────────────────────────────────────────────────
      - name: Install Live Stream Tools
        run: |
          # ttyd - web terminal (read-only)
          sudo wget -q https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.x86_64 -O /usr/local/bin/ttyd
          sudo chmod +x /usr/local/bin/ttyd

          # cloudflared tunnel
          sudo wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared

      # ─────────────────────────────────────────────────────────────
      # Pull agg Docker Image
      # ─────────────────────────────────────────────────────────────
      - name: Pull agg Docker Image
        run: docker pull ${{ env.AGG_IMAGE }}

      # ─────────────────────────────────────────────────────────────
      # Generate Recordings
      # ─────────────────────────────────────────────────────────────
      # ─────────────────────────────────────────────────────────────
      # Start Live Stream Tunnel
      # ─────────────────────────────────────────────────────────────
      - name: Start Cloudflare Tunnel
        id: tunnel
        run: |
          # Start cloudflare tunnel
          cloudflared tunnel --url http://localhost:7681 > /tmp/tunnel.log 2>&1 &
          CLOUDFLARED_PID=$!
          echo "CLOUDFLARED_PID=$CLOUDFLARED_PID" >> $GITHUB_ENV

          # Retry mechanism to get tunnel URL
          MAX_RETRIES=10
          RETRY_DELAY=3
          TUNNEL_URL=""

          echo "Waiting for Cloudflare tunnel URL..."
          for i in $(seq 1 $MAX_RETRIES); do
            TUNNEL_URL=$(grep -o 'https://[^[:space:]]*\.trycloudflare\.com' /tmp/tunnel.log | head -1)

            if [ -n "$TUNNEL_URL" ]; then
              echo "Tunnel URL obtained on attempt $i"
              break
            fi

            echo "  Attempt $i/$MAX_RETRIES - URL not ready, waiting ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          done

          if [ -z "$TUNNEL_URL" ]; then
            echo "ERROR: Failed to obtain tunnel URL after $MAX_RETRIES attempts"
            echo "Tunnel log:"
            cat /tmp/tunnel.log
            exit 1
          fi

          echo "════════════════════════════════════════════════════════════"
          echo "  LIVE TERMINAL STREAM (Read-Only)"
          echo "════════════════════════════════════════════════════════════"
          echo "  URL: $TUNNEL_URL"
          echo "════════════════════════════════════════════════════════════"
          echo ""

          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
          echo "tunnel_url=$TUNNEL_URL" >> $GITHUB_OUTPUT

      # ─────────────────────────────────────────────────────────────
      # Generate Recordings
      # ─────────────────────────────────────────────────────────────
      - name: Generate API Recordings with Live Stream
        working-directory: documentation/tools/scripts/recording_automations_api
        env:
          TERM: xterm-256color
          UNVEIL_DELAY: "0.04"
          RECORD_LIMIT: ${{ inputs.test_mode == true && '3' || '0' }}
        run: |
          chmod +x automate.sh
          chmod +x api/*.sh

          # Debug: Show configuration
          echo "RECORD_LIMIT=$RECORD_LIMIT"
          echo "TUNNEL_URL=$TUNNEL_URL"

          # Run automate.sh inside ttyd - viewers see the actual terminal session
          # asciinema records inside each script, ttyd streams the live view
          ttyd -p 7681 sudo -E bash -c "export RECORD_LIMIT=$RECORD_LIMIT UNVEIL_DELAY=$UNVEIL_DELAY TERM=$TERM && ./automate.sh"

          # Cleanup
          kill $CLOUDFLARED_PID 2>/dev/null || true

      # ─────────────────────────────────────────────────────────────
      # Convert .cast to .gif
      # ─────────────────────────────────────────────────────────────
      - name: Convert Recordings to GIF
        run: |
          echo "Converting .cast files to .gif..."

          for cast_file in ${{ env.RECORDINGS_DIR }}/*.cast; do
            [ -f "$cast_file" ] || continue

            filename=$(basename "$cast_file" .cast)
            gif_file="${{ env.RECORDINGS_DIR }}/${filename}.gif"

            echo "  Converting: $filename.cast → $filename.gif"

            docker run --rm \
              -v "$(pwd)/${{ env.RECORDINGS_DIR }}:/data" \
              ${{ env.AGG_IMAGE }} \
              "/data/${filename}.cast" \
              "/data/${filename}.gif" \
              --font-size 14 \
              --cols 120 \
              --rows 48
          done

          echo ""
          echo "Conversion complete. Files:"
          ls -la ${{ env.RECORDINGS_DIR }}/

      # ─────────────────────────────────────────────────────────────
      # Upload Artifacts
      # ─────────────────────────────────────────────────────────────
      - name: Upload Recordings Artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-recordings-${{ github.run_id }}
          path: |
            ${{ env.RECORDINGS_DIR }}/*.cast
            ${{ env.RECORDINGS_DIR }}/*.gif
          retention-days: 90

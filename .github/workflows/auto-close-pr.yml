name: Auto Close External PRs

on:
  pull_request_target:
    types: [opened]

env:
  ALLOWED_USERS: "remrearas"

jobs:
  auto-close:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Check and close unauthorized PR
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_AUTHOR_TYPE: ${{ github.event.pull_request.user.type }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if author is in allowed list
          IS_ALLOWED=false
          for user in $ALLOWED_USERS; do
            if [ "$PR_AUTHOR" = "$user" ]; then
              IS_ALLOWED=true
              break
            fi
          done

          if [ "$IS_ALLOWED" = "true" ]; then
            echo "âœ… Authorized user: $PR_AUTHOR"
            exit 0
          fi

          # Block ALL bot accounts - no exceptions
          # This catches: copilot-swe-agent[bot], dependabot[bot],
          # github-actions[bot], renovate[bot], and any future bot
          IS_BOT=false

          # Check GitHub account type
          if [ "$PR_AUTHOR_TYPE" = "Bot" ]; then
            IS_BOT=true
          fi

          # Check for [bot] suffix pattern (covers all GitHub App bots)
          if [[ "$PR_AUTHOR" == *"[bot]"* ]]; then
            IS_BOT=true
          fi

          # Explicit Copilot and known bot blocklist
          BLOCKED_BOTS="copilot-swe-agent copilot copilot-swe-agent[bot] github-actions github-actions[bot] dependabot dependabot[bot] dependabot-bot renovate renovate[bot]"
          for bot in $BLOCKED_BOTS; do
            if [ "$PR_AUTHOR" = "$bot" ]; then
              IS_BOT=true
              break
            fi
          done

          # Determine message and close
          if [ "$IS_BOT" = "true" ]; then
            MESSAGE="ðŸš« Bot-generated PRs are not accepted in this repository. This PR has been automatically closed."
          else
            MESSAGE="ðŸš« External contributions are not accepted in this repository. This PR has been automatically closed."
          fi

          echo "ðŸš« Closing PR #$PR_NUMBER from unauthorized author: $PR_AUTHOR (type: $PR_AUTHOR_TYPE)"

          # Post comment
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            -d "{\"body\": \"$MESSAGE\"}"

          # Close PR
          curl -s -X PATCH \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}" \
            -d '{"state": "closed"}'
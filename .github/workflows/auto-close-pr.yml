name: Auto Close External PRs

on:
  pull_request_target:
    types: [opened]

env:
  ALLOWED_USERS: remrearas
  BLOCKED_BOTS: copilot-swe-agent copilot

jobs:
  auto-close:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Check and close unauthorized PR
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_AUTHOR_TYPE: ${{ github.event.pull_request.user.type }}
        run: |
          REASON=""

          # Block known bots
          for bot in $BLOCKED_BOTS; do
            if [ "$PR_AUTHOR" = "$bot" ]; then
              REASON="bot"
              break
            fi
          done

          # Block any Bot-type account
          if [ -z "$REASON" ] && [ "$PR_AUTHOR_TYPE" = "Bot" ]; then
            REASON="bot"
          fi

          # Block external users
          if [ -z "$REASON" ]; then
            ALLOWED=false
            for user in $ALLOWED_USERS; do
              if [ "$PR_AUTHOR" = "$user" ]; then
                ALLOWED=true
                break
              fi
            done
            if [ "$ALLOWED" = false ]; then
              REASON="external"
            fi
          fi

          # If no reason, PR is allowed
          if [ -z "$REASON" ]; then
            echo "PR #$PR_NUMBER by $PR_AUTHOR is allowed"
            exit 0
          fi

          echo "Closing PR #$PR_NUMBER by $PR_AUTHOR (reason: $REASON)"

          if [ "$REASON" = "bot" ]; then
            MSG="ðŸš« Bot-generated PRs are not accepted in this repository. This PR has been automatically closed."
          else
            # Fetch external PR template from repo without checkout
            MSG=$(gh api "repos/$GH_REPO/contents/.github/external_pull_request_template.md" --jq '.content' | base64 -d) || \
              MSG="ðŸš« External contributions are not accepted in this repository. This PR has been automatically closed."
          fi

          gh pr comment "$PR_NUMBER" --repo "$GH_REPO" --body "$MSG"
          gh pr close "$PR_NUMBER" --repo "$GH_REPO"
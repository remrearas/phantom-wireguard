name: Generate CLI Recordings

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'tools/recording-utilities/phantom-recorder/**'

permissions:
  contents: write

env:
  RECORDER_SRC: tools/recording-utilities/phantom-recorder
  RECORDER_DIR: /tmp/rec
  AGG_IMAGE: ghcr.io/asciinema/agg:latest

jobs:
  record:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────────────────────
      # Setup
      # ─────────────────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Phantom-WG
        run: |
          chmod +x phantom-install.sh
          sudo ./phantom-install.sh

      - name: Verify Phantom-WG Installation
        run: |
          if [ ! -d "/opt/phantom-wg" ] || [ ! -f "/opt/phantom-wg/.phantom-venv/bin/python" ]; then
            echo "Error: Phantom-WG installation failed"
            exit 1
          fi
          echo "Phantom-WG installation verified"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y asciinema 
          pip install -r ${{ env.RECORDER_SRC }}/requirements.txt

      - name: Setup Recorder Directory
        run: |
          cp -r ${{ env.RECORDER_SRC }} ${{ env.RECORDER_DIR }}
          echo "Recorder copied to ${{ env.RECORDER_DIR }}"

      - name: Install Emoji Font
        run: |
          mkdir -p /tmp/fonts
          wget -q -O /tmp/fonts/NotoColorEmoji.ttf \
            https://github.com/googlefonts/noto-emoji/raw/main/fonts/NotoColorEmoji.ttf
          echo "Noto Color Emoji font downloaded"

      - name: Setup Shell Prompt
        run: |
          echo 'export PS1="root@server:~# "' >> ~/.bashrc
          echo "Shell prompt configured"

      # ─────────────────────────────────────────────────────────────
      # Pull agg Docker Image
      # ─────────────────────────────────────────────────────────────
      - name: Pull agg Docker Image
        run: docker pull ${{ env.AGG_IMAGE }}

      # ─────────────────────────────────────────────────────────────
      # Generate Recordings
      # ─────────────────────────────────────────────────────────────
      - name: Record All Workflows
        working-directory: ${{ env.RECORDER_DIR }}
        env:
          TERM: xterm-256color
        run: |
          # ─── Workflow Order (logical flow) ────────────────────────
          WORKFLOWS=(
            "add-client"
            "remove-client"
            "list-clients"
            "export-client"
            "latest-clients"
            "tweak_settings"
            "change_subnet"
            "get-firewall-status"
            "service-logs"
            "restart-service"
            "dns-compact"
          )

          for name in "${WORKFLOWS[@]}"; do
            workflow="workflows/${name}.yaml"
            if [ ! -f "$workflow" ]; then
              echo "Warning: $workflow not found, skipping"
              continue
            fi
            echo "Recording: $name"
            python3 phantom_recorder.py "$workflow"
            echo ""
          done

      # ─────────────────────────────────────────────────────────────
      # Convert .cast to .gif
      # ─────────────────────────────────────────────────────────────
      - name: Convert Recordings to GIF
        working-directory: ${{ env.RECORDER_DIR }}
        run: |
          echo "Converting .cast files to .gif..."

          for cast_file in recordings/*.cast; do
            [ -f "$cast_file" ] || continue

            filename=$(basename "$cast_file" .cast)
            gif_file="recordings/${filename}.gif"

            echo "  Converting: $filename.cast → $filename.gif"

            docker run --rm \
              -v "$(pwd)/recordings:/data" \
              -v "/tmp/fonts:/fonts:ro" \
              ${{ env.AGG_IMAGE }} \
              "/data/${filename}.cast" \
              "/data/${filename}.gif" \
              --font-dir "/fonts" \
              --font-size 14 \
              --cols 120 \
              --rows 48
          done

          echo ""
          echo "Conversion complete. Files:"
          ls -la recordings/

      # ─────────────────────────────────────────────────────────────
      # Upload Artifacts
      # ─────────────────────────────────────────────────────────────
      - name: Upload Recordings Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-recordings-${{ github.run_id }}
          path: |
            ${{ env.RECORDER_DIR }}/recordings/*.cast
            ${{ env.RECORDER_DIR }}/recordings/*.gif
          retention-days: 90

      # ─────────────────────────────────────────────────────────────
      # Commit Recordings
      # ─────────────────────────────────────────────────────────────
      - name: Prepare Recordings for Commit
        working-directory: ${{ env.RECORDER_DIR }}
        run: |
          TARGET_BASE="$GITHUB_WORKSPACE/documentation/docs/assets/static/recordings/feature-showcase"

          # ── Mapping: workflow recordings -> documentation assets ──
          mkdir -p "$TARGET_BASE/cli"

          declare -A MAPPINGS=(
            ["add-client"]="add_client"
            ["remove-client"]="remove_client"
            ["list-clients"]="list_clients"
            ["export-client"]="export_client"
            ["latest-clients"]="latest_clients"
            ["tweak_settings"]="tweak_settings"
            ["change_subnet"]="change_subnet"
            ["get-firewall-status"]="get_firewall_status"
            ["service-logs"]="service_logs"
            ["restart-service"]="restart_service"
            ["dns-compact"]="dns_compact"
          )

          for src in "${!MAPPINGS[@]}"; do
            dst="${MAPPINGS[$src]}"
            if ls recordings/${src}_*.cast 1>/dev/null 2>&1; then
              cp recordings/${src}_*.cast "$TARGET_BASE/cli/${dst}"
              echo "Copied: ${src} -> cli/${dst}"
            fi
          done

          echo ""
          echo "Files ready for commit:"
          find "$TARGET_BASE" -type f -newer "$GITHUB_WORKSPACE/.git" 2>/dev/null || echo "No new files"

      - name: Commit and Push Recordings
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add documentation/docs/assets/static/recordings/feature-showcase/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update CLI recordings"
            git push
            echo "Recordings committed and pushed"
          fi


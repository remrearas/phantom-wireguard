name: Create Mac Release

on:
  push:
    tags: [ "mac-v*" ]

jobs:
  extract-version:
    name: Extract Version
    runs-on: ubuntu-latest
    permissions: {}
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/mac-v}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
            echo "::error::Invalid semver format: $VERSION (expected X.Y or X.Y.Z)"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  build-dmg:
    needs: extract-version
    uses: ./.github/workflows/deploy-dmg.yml
    permissions:
      contents: read
    with:
      version: ${{ needs.extract-version.outputs.version }}
    secrets:
      DEVELOPER_ID_CERTIFICATE_P12: ${{ secrets.DEVELOPER_ID_CERTIFICATE_P12 }}
      DEVELOPER_ID_CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
      MAC_PROVISIONING_PROFILE_APP: ${{ secrets.MAC_PROVISIONING_PROFILE_APP }}
      MAC_PROVISIONING_PROFILE_EXTENSION: ${{ secrets.MAC_PROVISIONING_PROFILE_EXTENSION }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}

  create-release:
    name: Create GitHub Release
    needs: [extract-version, build-dmg]
    runs-on: ubuntu-latest
    if: success()
    permissions:
      contents: write

    steps:
      - name: Download DMG artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: "Phantom-WG-MacOS-${{ needs.extract-version.outputs.version }}.dmg"
          path: ${{ runner.temp }}/release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          tag_name: "mac-v${{ needs.extract-version.outputs.version }}"
          name: "Phantom-WG Mac ${{ needs.extract-version.outputs.version }}"
          body: |
            ## Phantom-WG Mac ${{ needs.extract-version.outputs.version }}

            ---

            ### ðŸ‡ºðŸ‡¸

            #### Contents

            - `Phantom-WG Mac.app`

            #### Installation

            1. Download and open the DMG:
            ```
            Phantom-WG-MacOS-${{ needs.extract-version.outputs.version }}.dmg
            ```

            2. Drag **Phantom-WG Mac** to the **Applications** folder

            3. On first launch, approve the system extension:
               - **macOS 15+ (Sequoia):** System Settings â†’ General â†’ Login Items & Extensions â†’ Network Extensions
               - **macOS 14 (Sonoma):** System Settings â†’ Privacy & Security â†’ Extensions â†’ Network Extensions

            4. Import your tunnel configuration (JSON) and connect

            #### Requirements

            - macOS 14.0 (Sonoma) or later
            - Apple Silicon (arm64)

            ---

            ### ðŸ‡¹ðŸ‡·

            #### Paket

            - `Phantom-WG Mac.app`

            #### Kurulum

            1. DMG dosyasÄ±nÄ± indirin ve aÃ§Ä±n:
            ```
            Phantom-WG-MacOS-${{ needs.extract-version.outputs.version }}.dmg
            ```

            2. **Phantom-WG Mac** uygulamasÄ±nÄ± **Applications** klasÃ¶rÃ¼ne sÃ¼rÃ¼kleyin

            3. Ä°lk Ã§alÄ±ÅŸtÄ±rmada sistem uzantÄ±sÄ±nÄ± onaylayÄ±n:
               - **macOS 15+ (Sequoia):** Sistem AyarlarÄ± â†’ Genel â†’ Oturum AÃ§ma Ã–ÄŸeleri ve UzantÄ±lar â†’ AÄŸ UzantÄ±larÄ±
               - **macOS 14 (Sonoma):** Sistem AyarlarÄ± â†’ Gizlilik ve GÃ¼venlik â†’ UzantÄ±lar â†’ AÄŸ UzantÄ±larÄ±

            4. TÃ¼nel yapÄ±landÄ±rmanÄ±zÄ± (JSON) iÃ§e aktarÄ±n ve baÄŸlanÄ±n

            #### Gereksinimler

            - macOS 14.0 (Sonoma) veya Ã¼zeri
            - Apple Silicon (arm64)

          files: |
            ${{ runner.temp }}/release/Phantom-WG-MacOS-${{ needs.extract-version.outputs.version }}.dmg
          draft: false
          prerelease: false
          generate_release_notes: false

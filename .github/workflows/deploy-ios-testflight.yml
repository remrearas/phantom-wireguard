name: Deploy to TestFlight

on:
  workflow_dispatch:
    inputs:
      build_number:
        description: "Build number (leave empty for auto-increment)"
        required: false

env:
  PHANTOM_PROJECT_DIR: tools/ios/Phantom-WG
  SCHEME: Phantom-WG

jobs:
  deploy:
    name: Build & Upload to TestFlight
    runs-on: macos-26
    timeout-minutes: 30
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Go for WireGuardKit
        run: brew install go@1.22

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        working-directory: ${{ env.PHANTOM_PROJECT_DIR }}
        run: xcodegen generate

      - name: Install Apple certificate
        env:
          P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          echo -n "$P12_BASE64" | base64 --decode -o "$CERT_PATH"

          KEYCHAIN_PATH="$RUNNER_TEMP/signing.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERT_PATH" \
            -P "$P12_PASSWORD" -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Write App Store Connect API key
        env:
          ASC_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY }}
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo -n "$ASC_KEY_BASE64" | base64 --decode \
            -o ~/private_keys/AuthKey_${ASC_KEY_ID}.p8

      - name: Set build number
        run: |
          BUILD_NUMBER="${{ github.event.inputs.build_number }}"
          if [ -z "$BUILD_NUMBER" ]; then
            BUILD_NUMBER="${{ github.run_number }}"
          fi
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> "$GITHUB_ENV"
          echo "Build number: $BUILD_NUMBER"

      - name: Archive
        working-directory: ${{ env.PHANTOM_PROJECT_DIR }}
        run: |
          set -o pipefail
          xcodebuild archive \
            -scheme "${{ env.SCHEME }}" \
            -archivePath "$RUNNER_TEMP/Phantom-WG.xcarchive" \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${{ secrets.ASC_KEY_ID }}.p8 \
            -authenticationKeyID "${{ secrets.ASC_KEY_ID }}" \
            -authenticationKeyIssuerID "${{ secrets.ASC_ISSUER_ID }}" \
            CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
            2>&1 | xcpretty --color

      - name: Export & Upload to TestFlight
        run: |
          cat > "$RUNNER_TEMP/ExportOptions.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>destination</key>
            <string>upload</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/Phantom-WG.xcarchive" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist" \
            -exportPath "$RUNNER_TEMP/export" \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${{ secrets.ASC_KEY_ID }}.p8 \
            -authenticationKeyID "${{ secrets.ASC_KEY_ID }}" \
            -authenticationKeyIssuerID "${{ secrets.ASC_ISSUER_ID }}"

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
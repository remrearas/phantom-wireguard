#file: noinspection HttpUrlsUsage
name: Deploy to TestFlight

on:
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number override (leave empty to use run_number)'
        required: false
        type: string

concurrency:
  group: testflight-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: Phantom-WG
  ARCHIVE_PATH: ${{ runner.temp }}/Phantom-WG.xcarchive
  KEYCHAIN_PATH: ${{ runner.temp }}/signing.keychain-db
  API_KEY_DIR: ${{ runner.temp }}/private_keys

jobs:
  deploy:
    name: Build & Upload to TestFlight
    runs-on: macos-26
    timeout-minutes: 45
    steps:

      # ── 1. Checkout ──────────────────────────────────────────
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ── 2. Install build tools ───────────────────────────────
      - name: Install Go 1.22 for WireGuardKit
        run: brew install go@1.22

      - name: Install XcodeGen
        run: brew install xcodegen

      # ── 3. Generate Xcode project ───────────────────────────
      - name: Generate Xcode project
        run: xcodegen generate

      # ── 4. Determine build number ───────────────────────────
      - name: Set build number
        run: |
          BUILD_NUMBER="${{ github.event.inputs.build_number }}"
          if [ -z "$BUILD_NUMBER" ]; then
            BUILD_NUMBER="${{ github.run_number }}"
          fi
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> "$GITHUB_ENV"
          echo "::notice::Build number: $BUILD_NUMBER"

      # ── 5. Import distribution certificate ──────────────────
      - name: Import code-signing certificate
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERT_PATH="${RUNNER_TEMP}/certificate.p12"
          KEYCHAIN_PASSWORD="$(uuidgen)"

          echo -n "$APPLE_CERTIFICATE_P12" | base64 --decode -o "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERT_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security set-key-partition-list \
            -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"

          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

          echo "::group::Verify certificate"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"
          echo "::endgroup::"

      # ── 6. Write App Store Connect API key ──────────────────
      - name: Write App Store Connect API key
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_PRIVATE_KEY: ${{ secrets.ASC_PRIVATE_KEY }}
        run: |
          mkdir -p "$API_KEY_DIR"
          API_KEY_PATH="${API_KEY_DIR}/AuthKey_${ASC_KEY_ID}.p8"
          echo -n "$ASC_PRIVATE_KEY" > "$API_KEY_PATH"
          echo "API_KEY_PATH=$API_KEY_PATH" >> "$GITHUB_ENV"

          if ! head -1 "$API_KEY_PATH" | grep -q "BEGIN PRIVATE KEY"; then
            echo "::error::API key does not appear to be a valid .p8 PEM file"
            exit 1
          fi

      # ── 7. Archive ──────────────────────────────────────────
      - name: Archive
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
        run: |
          set -o pipefail
          xcodebuild archive \
            -scheme "$SCHEME" \
            -archivePath "$ARCHIVE_PATH" \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$API_KEY_PATH" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
            2>&1 | xcbeautify --renderer github-actions

      # ── 8. Export & Upload to TestFlight ────────────────────
      - name: Export and upload to TestFlight
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
        run: |
          cat > "${RUNNER_TEMP}/ExportOptions.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>destination</key>
            <string>upload</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>teamID</key>
            <string>9C5SL5H7CM</string>
            <key>uploadSymbols</key>
            <true/>
          </dict>
          </plist>
          PLIST

          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist "${RUNNER_TEMP}/ExportOptions.plist" \
            -exportPath "${RUNNER_TEMP}/export" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$API_KEY_PATH" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID"

          echo "::notice::Upload to TestFlight complete"

      # ── 9. Cleanup ──────────────────────────────────────────
      - name: Cleanup keychain and secrets
        if: always()
        run: |
          security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
          rm -rf "$API_KEY_DIR" 2>/dev/null || true
          rm -f "${RUNNER_TEMP}/certificate.p12" 2>/dev/null || true
